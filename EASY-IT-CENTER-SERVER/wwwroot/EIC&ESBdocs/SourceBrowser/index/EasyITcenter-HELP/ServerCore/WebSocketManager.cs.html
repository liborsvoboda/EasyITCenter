<!DOCTYPE html>
<html><head><title>WebSocketManager.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(92);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#EasyITcenter-HELP/ServerCore/WebSocketManager.cs" target="_top">ServerCore\WebSocketManager.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#EasyITcenter-HELP" target="_top">HelpProjects\EasyITcenter-HELP\EasyITcenter-HELP.csproj</a> (EasyITcenter-HELP)</td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">/*
* Server Core Web Helpers
* System Extensions for Correct Core working
* DataTypes Conversion Support, etc.
*/</span>
 
<b>namespace</b> <span class="i n">EasyITCenter</span>.<span class="i n">ServerCoreStructure</span> {
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Server Web Helpers for EASY working Here are extension for Database Model, WebSocket</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public static class</b> <a id="abc9b696d8dfe043" href="../R/abc9b696d8dfe043.html" target="n" data-glyph="0,0" class="t t">ServerCoreWebHelpers</a> {
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> WebSocketsCentralControllerMethods Helper
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Sends the message to client WebSocket. This Is Used by</span>
        <span class="c">///</span><span class="c"> &quot;SendMessageAndUpdateWebSocketsInSpecificPath&quot; For Update Informaions on All Connections</span>
        <span class="c">///</span><span class="c"> in Same WebSocket Path Its Solution FOR Teminals, Group Communications, etc.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r0 r">webSocket</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The web socket.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1 r">message</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">  The message.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public static async</b> <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="be5d4732298deacb" href="../R/be5d4732298deacb.html" target="n" data-glyph="72,1" class="i method">SendMessageToClientSocket</a>(<span class="i">WebSocket</span> <span id="r0 rd" class="r0 r">webSocket</span>, <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r1 rd" class="r1 r">message</span>) {
            <b>await</b> <span class="r0 r">webSocket</span>.<span class="i">SendAsync</span>(<b>new</b> <span class="t">ArraySegment</span>&lt;<b>byte</b>&gt;(<span class="i">Encoding</span>.<span class="i">UTF8</span>.<span class="i">GetBytes</span>(<span class="r1 r">message</span>), 0, <span class="i">Encoding</span>.<span class="i">UTF8</span>.<span class="i">GetBytes</span>(<span class="r1 r">message</span>).<span class="i">Length</span>),
                       <span class="i">WebSocketMessageType</span>.<span class="i">Text</span>, <b>true</b>, <a href="@1@System.Runtime/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a>.<a href="@1@System.Runtime/A.html#ec32c41597007382" class="i property">None</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Register Listening Client WebSocket Communication Ist for Receive messages from Client</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r2 r">webSocket</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">    </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r3 r">socketAPIPath</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public static async</b> <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="c9dbb541bf817368" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">ListenClientWebSocketMessages</a>(<span class="i">WebSocket</span> <span id="r2 rd" class="r2 r">webSocket</span>, <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r3 rd" class="r3 r">socketAPIPath</span>) {
            <b>var</b> <span id="r4 rd" class="r4 r">buffer</span> = <b>new</b> <b>byte</b>[1024 * <a href="Classes/ServerConfigurationDefinitions.cs.html#de6c49ae64743fc3" class="t t">ServerConfigSettings</a>.<a href="Classes/ServerConfigurationDefinitions.cs.html#000d6cb33fbef62d" class="i property">WebSocketMaxBufferSizeKb</a>];
            <b>var</b> <span id="r5 rd" class="r5 r">receiveResult</span> = <b>await</b> <span class="r2 r">webSocket</span>.<span class="i">ReceiveAsync</span>(<b>new</b> <a href="@1@System.Runtime/A.html#1598c83841ba2e3f" class="t constructor">ArraySegment</a>&lt;<b>byte</b>&gt;(<span class="r4 r">buffer</span>), <a href="@1@System.Runtime/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a>.<a href="@1@System.Runtime/A.html#ec32c41597007382" class="i property">None</a>);
 
            <b>while</b> (!<span class="r5 r">receiveResult</span>.<span class="i">CloseStatus</span>.<span class="i">HasValue</span>) {
                <a href="#71f01787c52f4e9b" class="i method">SendMessageAndUpdateWebSocketsInSpecificPath</a>(<span class="r3 r">socketAPIPath</span>, <span class="s">&quot;&quot;</span>);
                <span class="r5 r">receiveResult</span> = <b>await</b> <span class="r2 r">webSocket</span>.<span class="i">ReceiveAsync</span>(<b>new</b> <a href="@1@System.Runtime/A.html#1598c83841ba2e3f" class="t constructor">ArraySegment</a>&lt;<b>byte</b>&gt;(<span class="r4 r">buffer</span>), <a href="@1@System.Runtime/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a>.<a href="@1@System.Runtime/A.html#ec32c41597007382" class="i property">None</a>);
            }
 
            <b>await</b> <span class="r2 r">webSocket</span>.<span class="i">CloseAsync</span>(<span class="r5 r">receiveResult</span>.<span class="i">CloseStatus</span>.<span class="i">Value</span>, <span class="r5 r">receiveResult</span>.<span class="i">CloseStatusDescription</span>, <a href="@1@System.Runtime/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a>.<a href="@1@System.Runtime/A.html#ec32c41597007382" class="i property">None</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Add WeSocket Connection To Central List</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r6 r">newWebSocket</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c"> The new web socket.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r7 r">socketAPIPath</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The socket path.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public static async void</b> <a id="e14d27b6730ba739" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">AddSocketConnectionToCentralList</a>(<span class="i">WebSocket</span> <span id="r6 rd" class="r6 r">newWebSocket</span>, <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r7 rd" class="r7 r">socketAPIPath</span>) {
            <a href="Classes/ServerCoreRuntimeDefinitions.cs.html#b22b05b0ecb479ff" class="t t">ServerRuntimeData</a>.<a href="Classes/ServerCoreRuntimeDefinitions.cs.html#b549c33e2de981c6" class="i field">CentralWebSocketList</a>.<span class="i">Add</span>(<b>new</b> <a href="@1@System.Runtime/A.html#ee1efa9bd0176f36" class="t constructor">Tuple</a>&lt;<span class="i">WebSocket</span>, <a href="Classes/WebSocketClassesDefinitions.cs.html#e6f456aa8dbebccb" class="t t">WebSocketExtension</a>&gt;(<span class="r6 r">newWebSocket</span>, <b>new</b> <a href="Classes/WebSocketClassesDefinitions.cs.html#e6f456aa8dbebccb" class="t constructor">WebSocketExtension</a>() {
                <a href="Classes/WebSocketClassesDefinitions.cs.html#bd85b7709b3521c3" class="i property">socketAPIPath</a> = <span class="r7 r">socketAPIPath</span>,
                <a href="Classes/WebSocketClassesDefinitions.cs.html#46104944ec3e596f" class="i property">SocketTimeout</a> = <a href="@1@System.Runtime/A.html#68b4bb83ce8d1c31" class="t t">DateTimeOffset</a>.<a href="@1@System.Runtime/A.html#04abe0cac293ebd0" class="i property">UtcNow</a>.<a href="@1@System.Runtime/A.html#4658bd43b97f915c" class="i method">AddMinutes</a>(<a href="Classes/ServerConfigurationDefinitions.cs.html#de6c49ae64743fc3" class="t t">ServerConfigSettings</a>.<a href="Classes/ServerConfigurationDefinitions.cs.html#ffcfbcf4f111cb29" class="i property">WebSocketTimeoutMin</a>)
            }));
 
            <span class="c">//welcome message</span>
            <b>await</b> <a href="#be5d4732298deacb" class="i method">SendMessageToClientSocket</a>(<span class="r6 r">newWebSocket</span>, <a href="Classes/ServerConfigurationDefinitions.cs.html#de6c49ae64743fc3" class="t t">ServerConfigSettings</a>.<a href="Classes/ServerConfigurationDefinitions.cs.html#df12387ffd1b520a" class="i property">ConfigCoreServerRegisteredName</a> + <span class="s">&quot; &quot;</span> + <a href="Operations/DbOperations.cs.html#5e321d86347562f3" class="t t">DbOperations</a>.<a href="Operations/DbOperations.cs.html#e9a50c31c113e4e8" class="i method">DBTranslate</a>(<span class="s">&quot;welcome&quot;</span>));
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Sends the message and update web sockets in specific path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r8 r">socketAPIPath</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The socket API path.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r9 r">message</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">      The message.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public static async void</b> <a id="71f01787c52f4e9b" href="../R/71f01787c52f4e9b.html" target="n" data-glyph="72,1" class="i method">SendMessageAndUpdateWebSocketsInSpecificPath</a>(<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r8 rd" class="r8 r">socketAPIPath</span>, <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r9 rd" class="r9 r">message</span>) {
            <span class="c">//clean invalid Sockets before updating</span>
            <a href="#0060b73fded0f7f1" class="i method">DisposeSocketConnectionsWithTimeOut</a>();
 
            <b>foreach</b> (<a href="@1@System.Runtime/A.html#1806cf6634f5a371" class="t t">Tuple</a>&lt;<span class="i">WebSocket</span>, <a href="Classes/WebSocketClassesDefinitions.cs.html#e6f456aa8dbebccb" class="t t">WebSocketExtension</a>&gt; <span id="r10 rd" class="r10 r">socket</span> <b>in</b> <a href="Classes/ServerCoreRuntimeDefinitions.cs.html#b22b05b0ecb479ff" class="t t">ServerRuntimeData</a>.<a href="Classes/ServerCoreRuntimeDefinitions.cs.html#b549c33e2de981c6" class="i field">CentralWebSocketList</a>) {
                <b>if</b> (<span class="r10 r">socket</span>.<a href="@1@System.Runtime/A.html#85ddc983cace902c" class="i property">Item2</a>.<a href="Classes/WebSocketClassesDefinitions.cs.html#bd85b7709b3521c3" class="i property">socketAPIPath</a> == <span class="r8 r">socketAPIPath</span>) {
                    <b>await</b> <a href="#be5d4732298deacb" class="i method">SendMessageToClientSocket</a>(<span class="r10 r">socket</span>.<a href="@1@System.Runtime/A.html#d1922db1cf9dcd03" class="i property">Item1</a>, <span class="r9 r">message</span>);
                    <span class="r10 r">socket</span>.<a href="@1@System.Runtime/A.html#85ddc983cace902c" class="i property">Item2</a>.<a href="Classes/WebSocketClassesDefinitions.cs.html#46104944ec3e596f" class="i property">SocketTimeout</a> = <a href="@1@System.Runtime/A.html#68b4bb83ce8d1c31" class="t t">DateTimeOffset</a>.<a href="@1@System.Runtime/A.html#04abe0cac293ebd0" class="i property">UtcNow</a>.<a href="@1@System.Runtime/A.html#4658bd43b97f915c" class="i method">AddMinutes</a>(<a href="Classes/ServerConfigurationDefinitions.cs.html#de6c49ae64743fc3" class="t t">ServerConfigSettings</a>.<a href="Classes/ServerConfigurationDefinitions.cs.html#ffcfbcf4f111cb29" class="i property">WebSocketTimeoutMin</a>);
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> !! Global Method for Simple Using WebSockets WebSocket Disposed - Cleaning monitored</span>
        <span class="c">///</span><span class="c"> Sockets from Central List. Are Closed and Disposed Only with Timeout or with closed Connection</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public static int</b> <a id="0060b73fded0f7f1" href="../R/0060b73fded0f7f1.html" target="n" data-glyph="72,1" class="i method">DisposeSocketConnectionsWithTimeOut</a>() {
            <a href="Classes/ServerCoreRuntimeDefinitions.cs.html#b22b05b0ecb479ff" class="t t">ServerRuntimeData</a>.<a href="Classes/ServerCoreRuntimeDefinitions.cs.html#b549c33e2de981c6" class="i field">CentralWebSocketList</a>.<span class="i">ForEach</span>(<span id="r11 rd" class="r11 r">socket</span> =&gt; {
                <b>if</b> (<span class="r11 r">socket</span>.<a href="@1@System.Runtime/A.html#85ddc983cace902c" class="i property">Item2</a>.<a href="Classes/WebSocketClassesDefinitions.cs.html#46104944ec3e596f" class="i property">SocketTimeout</a> &lt; <a href="@1@System.Runtime/A.html#68b4bb83ce8d1c31" class="t t">DateTimeOffset</a>.<a href="@1@System.Runtime/A.html#04abe0cac293ebd0" class="i property">UtcNow</a>) { <span class="r11 r">socket</span>.<a href="@1@System.Runtime/A.html#d1922db1cf9dcd03" class="i property">Item1</a>.<span class="i">CloseAsync</span>(<span class="i">WebSocketCloseStatus</span>.<span class="i">NormalClosure</span>, <b>null</b>, <a href="@1@System.Runtime/A.html#36b17ded8b1a228c" class="t t">CancellationToken</a>.<a href="@1@System.Runtime/A.html#ec32c41597007382" class="i property">None</a>); }
            });
            <a href="Classes/ServerCoreRuntimeDefinitions.cs.html#b22b05b0ecb479ff" class="t t">ServerRuntimeData</a>.<a href="Classes/ServerCoreRuntimeDefinitions.cs.html#b549c33e2de981c6" class="i field">CentralWebSocketList</a>.<span class="i">RemoveAll</span>(<span id="r12 rd" class="r12 r">socket</span> =&gt; <span class="r12 r">socket</span>.<a href="@1@System.Runtime/A.html#d1922db1cf9dcd03" class="i property">Item1</a>.<span class="i property">State</span> != <span class="i">WebSocketState</span>.<span class="i">Open</span>);
            <b>return</b> <a href="Classes/ServerCoreRuntimeDefinitions.cs.html#b22b05b0ecb479ff" class="t t">ServerRuntimeData</a>.<a href="Classes/ServerCoreRuntimeDefinitions.cs.html#b549c33e2de981c6" class="i field">CentralWebSocketList</a>.<span class="i property">Count</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> WebSocketsCentralControllerMethods Helper
    }
}</pre></td></tr></table></div></body></html>
