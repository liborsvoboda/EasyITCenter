<!DOCTYPE html>
<html><head><title>WindowsSettingBehavior.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(219);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#MahApps.Metro/Behaviors/WindowsSettingBehavior.cs" target="_top">Behaviors\WindowsSettingBehavior.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#MahApps.Metro" target="_top">HelpProjects\WPF-MAIN\MahApps.Metro\src\MahApps.Metro\MahApps.Metro.csproj</a> (MahApps.Metro)</td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Licensed to the .NET Foundation under one or more agreements.</span>
<span class="c">// The .NET Foundation licenses this file to you under the MIT license.</span>
<span class="c">// See the LICENSE file in the project root for more information.</span>

<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Diagnostics</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Runtime</span>.<span class="i n">InteropServices</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Windows</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Windows</span>.<span class="i n">Interop</span>;
<b>using</b> <span class="i n">Windows</span>.<span class="i n">Win32</span>;
<b>using</b> <span class="i n">Windows</span>.<span class="i n">Win32</span>.<span class="i n">Foundation</span>;
<b>using</b> <span class="i n">Windows</span>.<span class="i n">Win32</span>.<span class="i n">Graphics</span>.<span class="i n">Gdi</span>;
<b>using</b> <span class="i n">Windows</span>.<span class="i n">Win32</span>.<span class="i n">UI</span>.<span class="i n">WindowsAndMessaging</span>;
<b>using</b> <span class="i n">MahApps</span>.<span class="i n">Metro</span>.<span class="i n">Controls</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Xaml</span>.<span class="i n">Behaviors</span>;

<b>namespace</b> <span class="i n">MahApps</span>.<span class="i n">Metro</span>.<span class="i n">Behaviors</span>
{
    <b>public class</b> <a id="dd9b0a7ecee7275c" href="../R/dd9b0a7ecee7275c.html" target="n" data-glyph="0,0" class="t t"><span id="63405fca47133805">WindowsSettingBehavior</span></a> : <span class="t t">Behavior</span>&lt;<a href="../Controls/MetroWindow.cs.html#5a37f9897ea7f8e0" class="t t">MetroWindow</a>&gt;
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">inheritdoc</span> <span class="c">/&gt;</span>
        <b>protected override void</b> <a id="b46e6b0e95dc36f6" href="../R/b46e6b0e95dc36f6.html" target="n" data-glyph="75,1" class="i method">OnAttached</a>()
        {
            <b>base</b>.<span class="i method">OnAttached</span>();

            <a href="#dd9b0a7ecee7275c" class="k">this</a>.<a href="#732015b0829d4f8c" class="i method">LoadWindowState</a>();

            <a href="../Controls/MetroWindow.cs.html#5a37f9897ea7f8e0" class="k">var</a> <span id="r0 rd" class="r0 r">window</span> = <a href="#dd9b0a7ecee7275c" class="k">this</a>.<span class="i property">AssociatedObject</span>;
            <b>if</b> (<span class="r0 r">window</span> <b>is null</b>)
            {
                <span class="c">// if the associated object is null at this point, then there is really something wrong!</span>
                <a href="@0@System/A.html#c63a0f19b2d4db69" class="t t">Trace</a>.<a href="@0@System/A.html#3e7f2b0454b49e5c" class="i method">TraceError</a>(<span class="s">$&quot;</span>{<a href="#dd9b0a7ecee7275c" class="k">this</a>}<span class="s">: Can not attach to nested events, cause the AssociatedObject is null.</span><span class="s">&quot;</span>);
                <b>return</b>;
            }

            <span class="r0 r">window</span>.<a href="@0@PresentationFramework/A.html#3325cf754593d931" class="i">StateChanged</a> += <a href="#dd9b0a7ecee7275c" class="k">this</a>.<a href="#a263e59f3172ea4e" class="i method">AssociatedObject_StateChanged</a>;
            <span class="r0 r">window</span>.<a href="@0@PresentationFramework/A.html#b6174546060fdecd" class="i">Closing</a> += <a href="#dd9b0a7ecee7275c" class="k">this</a>.<a href="#d95bd907212166e4" class="i method">AssociatedObject_Closing</a>;
            <span class="r0 r">window</span>.<a href="@0@PresentationFramework/A.html#9fd79ba8127bdb15" class="i">Closed</a> += <a href="#dd9b0a7ecee7275c" class="k">this</a>.<a href="#2ffbc6adc23cb246" class="i method">AssociatedObject_Closed</a>;

            <span class="c">// This operation must be thread safe. It is possible, that the window is running in a different Thread.</span>
            <a href="@0@PresentationFramework/A.html#cf9c51e402f97b05" class="t t">Application</a>.<a href="@0@PresentationFramework/A.html#e6ee08846cb73154" class="i property">Current</a>?.<a href="../Controls/Extensions.cs.html#9586488de223aab7" class="i method">BeginInvoke</a>(<span id="r1 rd" class="r1 r">app</span> =&gt;
                {
                    <b>if</b> (<span class="r1 r">app</span> != <b>null</b>)
                    {
                        <span class="r1 r">app</span>.<a href="@0@PresentationFramework/A.html#ba12dd0a0750c1ae" class="i">SessionEnding</a> += <a href="#dd9b0a7ecee7275c" class="k">this</a>.<a href="#eb3946900a9848f9" class="i method">CurrentApplicationSessionEnding</a>;
                    }
                });
        }

        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">inheritdoc</span> <span class="c">/&gt;</span>
        <b>protected override void</b> <a id="fd1c7e1510b8e377" href="../R/fd1c7e1510b8e377.html" target="n" data-glyph="75,1" class="i method">OnDetaching</a>()
        {
            <a href="#dd9b0a7ecee7275c" class="k">this</a>.<a href="#f87db1198d21534f" class="i method">CleanUp</a>(<span class="s">&quot;from OnDetaching&quot;</span>);
            <b>base</b>.<span class="i method">OnDetaching</span>();
        }

        <b>private void</b> <a id="d95bd907212166e4" href="../R/d95bd907212166e4.html" target="n" data-glyph="76,1" class="i method">AssociatedObject_Closing</a>(<b>object</b>? <span id="r2 rd" class="r2 r">sender</span>, <span class="i n">System</span>.<span class="i n">ComponentModel</span>.<a href="@0@System/A.html#f3f0af957be5a083" class="t t">CancelEventArgs</a> <span id="r3 rd" class="r3 r">e</span>)
        {
            <a href="#dd9b0a7ecee7275c" class="k">this</a>.<a href="#aca9230047d689da" class="i method">SaveWindowState</a>();
        }

        <b>private void</b> <a id="2ffbc6adc23cb246" href="../R/2ffbc6adc23cb246.html" target="n" data-glyph="76,1" class="i method">AssociatedObject_Closed</a>(<b>object</b>? <span id="r4 rd" class="r4 r">sender</span>, <a href="@0@mscorlib/A.html#9a1496aa60befd10" class="t t">EventArgs</a> <span id="r5 rd" class="r5 r">e</span>)
        {
            <a href="#dd9b0a7ecee7275c" class="k">this</a>.<a href="#f87db1198d21534f" class="i method">CleanUp</a>(<span class="s">&quot;from AssociatedObject closed event&quot;</span>);
        }

        <b>private void</b> <a id="eb3946900a9848f9" href="../R/eb3946900a9848f9.html" target="n" data-glyph="76,1" class="i method">CurrentApplicationSessionEnding</a>(<b>object</b>? <span id="r6 rd" class="r6 r">sender</span>, <a href="@0@PresentationFramework/A.html#adb0ea4fe6c12046" class="t t">SessionEndingCancelEventArgs</a> <span id="r7 rd" class="r7 r">e</span>)
        {
            <a href="#dd9b0a7ecee7275c" class="k">this</a>.<a href="#aca9230047d689da" class="i method">SaveWindowState</a>();
        }

        <b>private void</b> <a id="a263e59f3172ea4e" href="../R/a263e59f3172ea4e.html" target="n" data-glyph="76,1" class="i method">AssociatedObject_StateChanged</a>(<b>object</b>? <span id="r8 rd" class="r8 r">sender</span>, <a href="@0@mscorlib/A.html#9a1496aa60befd10" class="t t">EventArgs</a> <span id="r9 rd" class="r9 r">e</span>)
        {
            <span class="c">// save the settings on this state change, because hidden windows gets no window placements</span>
            <span class="c">// all the saving stuff could be so much easier with ReactiveUI :-D</span>
            <b>if</b> (<a href="#dd9b0a7ecee7275c" class="k">this</a>.<span class="i property">AssociatedObject</span>?.<a href="@0@PresentationFramework/A.html#517238bcdb0593d7" class="i property">WindowState</a> == <a href="@0@PresentationFramework/A.html#27ce608a1c9bb620" class="t t">WindowState</a>.<a href="@0@PresentationFramework/A.html#2c66992bf048806c" class="i field">Minimized</a>)
            {
                <a href="#dd9b0a7ecee7275c" class="k">this</a>.<a href="#aca9230047d689da" class="i method">SaveWindowState</a>();
            }
        }

        <b>private void</b> <a id="f87db1198d21534f" href="../R/f87db1198d21534f.html" target="n" data-glyph="76,1" class="i method">CleanUp</a>(<a href="@0@mscorlib/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r10 rd" class="r10 r">fromWhere</span>)
        {
            <a href="../Controls/MetroWindow.cs.html#5a37f9897ea7f8e0" class="k">var</a> <span id="r11 rd" class="r11 r">window</span> = <a href="#dd9b0a7ecee7275c" class="k">this</a>.<span class="i property">AssociatedObject</span>;
            <b>if</b> (<span class="r11 r">window</span> <b>is null</b>)
            {
                <span class="c">// it&#39;s bad if the associated object is null, so trace this here</span>
                <a href="@0@System/A.html#c63a0f19b2d4db69" class="t t">Trace</a>.<a href="@0@System/A.html#ed0a145461a37c94" class="i method">TraceWarning</a>(<span class="s">$&quot;</span>{<a href="#dd9b0a7ecee7275c" class="k">this</a>}<span class="s">: Can not clean up </span>{<span class="r10 r">fromWhere</span>}<span class="s">, cause the AssociatedObject is null. This can maybe happen if this Behavior was already detached.</span><span class="s">&quot;</span>);
                <b>return</b>;
            }

            <a href="@0@System/A.html#632c6da37ce825df" class="t t">Debug</a>.<a href="@0@System/A.html#73de7bb60da320d3" class="i method">WriteLine</a>(<span class="s">$&quot;</span>{<a href="#dd9b0a7ecee7275c" class="k">this</a>}<span class="s">: Clean up </span>{<span class="r10 r">fromWhere</span>}<span class="s">.</span><span class="s">&quot;</span>);

            <span class="r11 r">window</span>.<a href="@0@PresentationFramework/A.html#3325cf754593d931" class="i">StateChanged</a> -= <a href="#dd9b0a7ecee7275c" class="k">this</a>.<a href="#a263e59f3172ea4e" class="i method">AssociatedObject_StateChanged</a>;
            <span class="r11 r">window</span>.<a href="@0@PresentationFramework/A.html#b6174546060fdecd" class="i">Closing</a> -= <a href="#dd9b0a7ecee7275c" class="k">this</a>.<a href="#d95bd907212166e4" class="i method">AssociatedObject_Closing</a>;
            <span class="r11 r">window</span>.<a href="@0@PresentationFramework/A.html#9fd79ba8127bdb15" class="i">Closed</a> -= <a href="#dd9b0a7ecee7275c" class="k">this</a>.<a href="#2ffbc6adc23cb246" class="i method">AssociatedObject_Closed</a>;

            <span class="c">// This operation must be thread safe</span>
            <a href="@0@PresentationFramework/A.html#cf9c51e402f97b05" class="t t">Application</a>.<a href="@0@PresentationFramework/A.html#e6ee08846cb73154" class="i property">Current</a>?.<a href="../Controls/Extensions.cs.html#9586488de223aab7" class="i method">BeginInvoke</a>(<span id="r12 rd" class="r12 r">app</span> =&gt;
                {
                    <b>if</b> (<span class="r12 r">app</span> != <b>null</b>)
                    {
                        <span class="r12 r">app</span>.<a href="@0@PresentationFramework/A.html#ba12dd0a0750c1ae" class="i">SessionEnding</a> -= <a href="#dd9b0a7ecee7275c" class="k">this</a>.<a href="#eb3946900a9848f9" class="i method">CurrentApplicationSessionEnding</a>;
                    }
                });
        }

        <b>private void</b> <a id="732015b0829d4f8c" href="../R/732015b0829d4f8c.html" target="n" data-glyph="76,1" class="i method">LoadWindowState</a>()
        {
            <a href="../Controls/MetroWindow.cs.html#5a37f9897ea7f8e0" class="k">var</a> <span id="r13 rd" class="r13 r">window</span> = <a href="#dd9b0a7ecee7275c" class="k">this</a>.<span class="i property">AssociatedObject</span>;
            <b>if</b> (<span class="r13 r">window</span> <b>is null</b>)
            {
                <b>return</b>;
            }

            <a href="../Controls/WindowSettings.cs.html#94741d1ddf18ef08" class="k">var</a> <span id="r14 rd" class="r14 r">settings</span> = <span class="r13 r">window</span>.<a href="../Controls/MetroWindow.cs.html#b013aabf080cbbbb" class="i method">GetWindowPlacementSettings</a>();
            <b>if</b> (<span class="r14 r">settings</span> <b>is null</b> || !<span class="r13 r">window</span>.<a href="../Controls/MetroWindow.cs.html#e55b45568cb3eceb" class="i property">SaveWindowPosition</a>)
            {
                <b>return</b>;
            }

            <b>try</b>
            {
                <span class="r14 r">settings</span>.<a href="../Controls/WindowSettings.cs.html#49bcf8f59373bad4" class="i method">Reload</a>();
            }
            <b>catch</b> (<a href="@0@mscorlib/A.html#f092fb2b893a0162" class="t t">Exception</a> <span id="r15 rd" class="r15 r">e</span>)
            {
                <a href="@0@System/A.html#c63a0f19b2d4db69" class="t t">Trace</a>.<a href="@0@System/A.html#3e7f2b0454b49e5c" class="i method">TraceError</a>(<span class="s">$&quot;</span>{<a href="#dd9b0a7ecee7275c" class="k">this</a>}<span class="s">: The settings for </span>{<span class="r13 r">window</span>}<span class="s"> could not be reloaded! </span>{<span class="r15 r">e</span>}<span class="s">&quot;</span>);
                <b>return</b>;
            }

            <span class="c">// check for existing placement and prevent empty bounds</span>
            <b>if</b> (<span class="r14 r">settings</span>.<a href="../Controls/WindowSettings.cs.html#e2c938f972ab3ba1" class="i property">Placement</a> <b>is null</b> || <span class="r14 r">settings</span>.<a href="../Controls/WindowSettings.cs.html#e2c938f972ab3ba1" class="i property">Placement</a>.<a href="../Controls/WindowSettings.cs.html#4172e32a9d827d95" class="i field">normalPosition</a>.<a href="@0@WindowsBase/A.html#9c4f573847595310" class="i property">IsEmpty</a>)
            {
                <b>return</b>;
            }

            <b>try</b>
            {
                <b>var</b> <span id="r16 rd" class="r16 r">wp</span> = <span class="r14 r">settings</span>.<a href="../Controls/WindowSettings.cs.html#e2c938f972ab3ba1" class="i property">Placement</a>.<a href="../Controls/WindowSettings.cs.html#f593f89d32407c96" class="i method">ToWINDOWPLACEMENT</a>();
                <a href="../Controls/WinApiHelper.cs.html#b24ca23dca93d100" class="t t">WinApiHelper</a>.<span class="i">SetWindowPlacement</span>(<span class="r13 r">window</span>, <span class="r16 r">wp</span>);
            }
            <b>catch</b> (<a href="@0@mscorlib/A.html#f092fb2b893a0162" class="t t">Exception</a> <span id="r17 rd" class="r17 r">ex</span>)
            {
                <b>throw</b> <b>new</b> <a href="../MahAppsException.cs.html#02ed58fa90416e56" class="t constructor">MahAppsException</a>(<span class="s">$&quot;</span><span class="s">Failed to set the window state for </span>{<span class="r13 r">window</span>}<span class="s"> from the settings.</span><span class="s">&quot;</span>, <span class="r17 r">ex</span>);
            }
        }

        <b>private void</b> <a id="aca9230047d689da" href="../R/aca9230047d689da.html" target="n" data-glyph="76,1" class="i method">SaveWindowState</a>()
        {
            <a href="../Controls/MetroWindow.cs.html#5a37f9897ea7f8e0" class="k">var</a> <span id="r18 rd" class="r18 r">window</span> = <a href="#dd9b0a7ecee7275c" class="k">this</a>.<span class="i property">AssociatedObject</span>;
            <b>if</b> (<span class="r18 r">window</span> <b>is null</b>)
            {
                <b>return</b>;
            }

            <a href="../Controls/WindowSettings.cs.html#94741d1ddf18ef08" class="k">var</a> <span id="r19 rd" class="r19 r">settings</span> = <span class="r18 r">window</span>.<a href="../Controls/MetroWindow.cs.html#b013aabf080cbbbb" class="i method">GetWindowPlacementSettings</a>();
            <b>if</b> (<span class="r19 r">settings</span> <b>is null</b> || !<span class="r18 r">window</span>.<a href="../Controls/MetroWindow.cs.html#e55b45568cb3eceb" class="i property">SaveWindowPosition</a>)
            {
                <b>return</b>;
            }

            <a href="@0@mscorlib/A.html#d99bf6ad49979009" class="k">var</a> <span id="r20 rd" class="r20 r">windowHandle</span> = <b>new</b> <a href="@0@PresentationFramework/A.html#fdbf322c4b24b279" class="t constructor">WindowInteropHelper</a>(<span class="r18 r">window</span>).<a href="@0@PresentationFramework/A.html#471dc96303f6513d" class="i method">EnsureHandle</a>();
            <b>var</b> <span id="r21 rd" class="r21 r">wp</span> = <b>new</b> <span class="t">WINDOWPLACEMENT</span>
                     {
                         <span class="i">length</span> = (<b>uint</b>)<a href="@0@mscorlib/A.html#489a61c84168b119" class="t t">Marshal</a>.<a href="@0@mscorlib/A.html#9fef1d6bb6a505fe" class="i method">SizeOf</a>&lt;<span class="t">WINDOWPLACEMENT</span>&gt;()
                     };
            <b>unsafe</b>
            {
                <span class="t">PInvoke</span>.<span class="i">GetWindowPlacement</span>(<b>new</b> <span class="t">HWND</span>(<span class="r20 r">windowHandle</span>), &amp;<span class="r21 r">wp</span>);
            }

            <span class="c">// check for saveable values</span>
            <b>if</b> (<span class="r21 r">wp</span>.<span class="i">showCmd</span> != <span class="t">SHOW_WINDOW_CMD</span>.<span class="i">SW_HIDE</span> &amp;&amp; <span class="r21 r">wp</span>.<span class="i">length</span> &gt; 0)
            {
                <b>if</b> (<span class="r21 r">wp</span>.<span class="i">showCmd</span> == <span class="t">SHOW_WINDOW_CMD</span>.<span class="i">SW_NORMAL</span>)
                {
                    <b>unsafe</b>
                    {
                        <b>var</b> <span id="r22 rd" class="r22 r">rect</span> = <b>new</b> <span class="t">RECT</span>();
                        <span class="t">PInvoke</span>.<span class="i">GetWindowRect</span>(<b>new</b> <span class="t">HWND</span>(<span class="r20 r">windowHandle</span>), &amp;<span class="r22 r">rect</span>);
                        <b>if</b> (<span class="r22 r">rect</span>.<span class="i">left</span> != 0
                            || <span class="r22 r">rect</span>.<span class="i">top</span> != 0
                            || <span class="r22 r">rect</span>.<span class="i">right</span> != 0
                            || <span class="r22 r">rect</span>.<span class="i">bottom</span> != 0)
                        {
                            <b>var</b> <span id="r23 rd" class="r23 r">monitor</span> = <span class="t">PInvoke</span>.<span class="i">MonitorFromWindow</span>(<b>new</b> <span class="t">HWND</span>(<span class="r20 r">windowHandle</span>), <span class="t">MONITOR_FROM_FLAGS</span>.<span class="i">MONITOR_DEFAULTTONEAREST</span>);
                            <b>if</b> (<span class="r23 r">monitor</span> != <a href="@0@mscorlib/A.html#d99bf6ad49979009" class="t t">IntPtr</a>.<a href="@0@mscorlib/A.html#d46202ed9b6005b2" class="i field">Zero</a>)
                            {
                                <b>var</b> <span id="r24 rd" class="r24 r">monitorInfo</span> = <b>new</b> <span class="t">MONITORINFO</span>
                                                  {
                                                      <span class="i">cbSize</span> = (<b>uint</b>)<a href="@0@mscorlib/A.html#489a61c84168b119" class="t t">Marshal</a>.<a href="@0@mscorlib/A.html#9fef1d6bb6a505fe" class="i method">SizeOf</a>&lt;<span class="t">MONITORINFO</span>&gt;()
                                                  };
                                <span class="t">PInvoke</span>.<span class="i">GetMonitorInfo</span>(<span class="r23 r">monitor</span>, &amp;<span class="r24 r">monitorInfo</span>);
                                <span class="r22 r">rect</span>.<span class="i">Offset</span>(<span class="r24 r">monitorInfo</span>.<span class="i">rcMonitor</span>.<span class="i">left</span> - <span class="r24 r">monitorInfo</span>.<span class="i">rcWork</span>.<span class="i">left</span>, <span class="r24 r">monitorInfo</span>.<span class="i">rcMonitor</span>.<span class="i">top</span> - <span class="r24 r">monitorInfo</span>.<span class="i">rcWork</span>.<span class="i">top</span>);
                            }

                            <span class="r21 r">wp</span>.<span class="i">rcNormalPosition</span> = <span class="r22 r">rect</span>;
                        }
                    }
                }

                <b>if</b> (!<span class="r21 r">wp</span>.<span class="i">rcNormalPosition</span>.<span class="i">IsEmpty</span>())
                {
                    <span class="r19 r">settings</span>.<a href="../Controls/WindowSettings.cs.html#e2c938f972ab3ba1" class="i property">Placement</a> = <a href="../Controls/WindowSettings.cs.html#672a2a1bd6579cc1" class="t t">WindowPlacementSetting</a>.<a href="../Controls/WindowSettings.cs.html#e92eb31d5e66edce" class="i method">FromWINDOWPLACEMENT</a>(<span class="r18 r">window</span>, <span class="r21 r">wp</span>);
                }
            }

            <b>try</b>
            {
                <span class="r19 r">settings</span>.<a href="../Controls/WindowSettings.cs.html#69fc00df5dff9670" class="i method">Save</a>();
            }
            <b>catch</b> (<a href="@0@mscorlib/A.html#f092fb2b893a0162" class="t t">Exception</a> <span id="r25 rd" class="r25 r">e</span>)
            {
                <a href="@0@System/A.html#c63a0f19b2d4db69" class="t t">Trace</a>.<a href="@0@System/A.html#3e7f2b0454b49e5c" class="i method">TraceError</a>(<span class="s">$&quot;</span>{<a href="#dd9b0a7ecee7275c" class="k">this</a>}<span class="s">: The settings could not be saved! </span>{<span class="r25 r">e</span>}<span class="s">&quot;</span>);
            }
        }
    }
}</pre></td></tr></table></div></body></html>
